<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="baidu-site-verification" content="6o2YzUB1JR"/>
    <meta name="description" content="爱唱歌健身的程序员 | 王伟达，Web & algorithm Lover，Server Enginee | 这里是 @王伟达 的个人博客，期待和你一起学习成长。">
    <meta name="keyword" content="DavidWangTM, 王伟达, 技术, 软件, 互联网, Mac, 算法, Linux, blog ,php ,android, ios">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        IOS 动画讲解七
            -
            DavidWang's Blog | 王伟达的博客
        
    </title>

    <link rel="canonical" href="http://DavidWangTM.github.io/2016/06/28/ios_core_animation7_introduction/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href=" /css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href=" /css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href=" /css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">DavidWang's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="/portfolio/">Portfolio</a>
                    </li>
                    
                    <li>
                        <a href="/markdown/">markdown</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/post-bg-e2e-ux.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/post-bg-e2e-ux.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#ios" title="ios">ios</a>
                        
                        <a class="tag" href="/tags/#core-animation" title="core-animation">core-animation</a>
                        
                    </div>
                    <h1>IOS 动画讲解七</h1>
                    
                    
                    <h2 class="subheading">隐式动画</h2>
                    
                    <span class="meta">Posted by DavidWang on June 28, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<h1 id="section">隐式动画</h1>

<blockquote>
  <p><em>按照我的意思去做，而不是我说的。</em> – 埃德娜，辛普森</p>
</blockquote>

<p>我们在第一部分讨论了Core Animation除了动画之外可以做到的任何事情。但是动画是Core Animation库一个非常显著的特性。这一章我们来看看它是怎么做到的。具体来说，我们先来讨论框架自动完成的<em>隐式动画</em>（除非你明确禁用了这个功能）。</p>

<h2 id="section-1">事务</h2>

<p>Core Animation基于一个假设，说屏幕上的任何东西都可以（或者可能）做动画。动画并不需要你在Core Animation中手动打开，相反需要明确地关闭，否则他会一直存在。</p>

<p>当你改变<code class="highlighter-rouge">CALayer</code>的一个可做动画的属性，它并不能立刻在屏幕上体现出来。相反，它是从先前的值平滑过渡到新的值。这一切都是默认的行为，你不需要做额外的操作。</p>

<p>这看起来这太棒了，似乎不太真实，我们来用一个demo解释一下：首先和第一章“图层树”一样创建一个蓝色的方块，然后添加一个按钮，随机改变它的颜色。代码见清单7.1。点击按钮，你会发现图层的颜色平滑过渡到一个新值，而不是跳变（图7.1）。</p>

<p>清单7.1 随机改变图层颜色</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">layerView</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">CALayer</span> <span class="o">*</span><span class="n">colorLayer</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
    <span class="c1">//create sublayer
</span>    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span> <span class="o">=</span> <span class="p">[</span><span class="n">CALayer</span> <span class="nf">layer</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">50</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="mi">50</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">blueColor</span><span class="p">].</span><span class="n">CGColor</span><span class="p">;</span>
    <span class="c1">//add it to our view
</span>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">layerView</span><span class="p">.</span><span class="n">layer</span> <span class="nf">addSublayer</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">IBAction</span><span class="p">)</span><span class="n">changeColor</span>
<span class="p">{</span>
    <span class="c1">//randomize the layer background color
</span>    <span class="n">CGFloat</span> <span class="n">red</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
    <span class="n">CGFloat</span> <span class="n">green</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
    <span class="n">CGFloat</span> <span class="n">blue</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">colorWithRed</span><span class="p">:</span><span class="n">red</span> <span class="nf">green</span><span class="p">:</span><span class="n">green</span> <span class="n">blue</span><span class="o">:</span><span class="n">blue</span> <span class="n">alpha</span><span class="o">:</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">].</span><span class="n">CGColor</span><span class="p">;</span>                                                                                       <span class="err">￼</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre>
</div>

<p><img src="/img/in-post/ios_introduction/7.1.jpeg" alt="IMG" /></p>

<p>图7.1 添加一个按钮来控制图层颜色</p>

<p>这其实就是所谓的<em>隐式</em>动画。之所以叫隐式是因为我们并没有指定任何动画的类型。我们仅仅改变了一个属性，然后Core Animation来决定如何并且何时去做动画。Core Animaiton同样支持<em>显式</em>动画，下章详细说明。</p>

<p>但当你改变一个属性，Core Animation是如何判断动画类型和持续时间的呢？实际上动画执行的时间取决于当前<em>事务</em>的设置，动画类型取决于<em>图层行为</em>。</p>

<p>事务实际上是Core Animation用来包含一系列属性动画集合的机制，任何用指定事务去改变可以做动画的图层属性都不会立刻发生变化，而是当事务一旦<em>提交</em>的时候开始用一个动画过渡到新值。</p>

<p>事务是通过<code class="highlighter-rouge">CATransaction</code>类来做管理，这个类的设计有些奇怪，不像你从它的命名预期的那样去管理一个简单的事务，而是管理了一叠你不能访问的事务。<code class="highlighter-rouge">CATransaction</code>没有属性或者实例方法，并且也不能用<code class="highlighter-rouge">+alloc</code>和<code class="highlighter-rouge">-init</code>方法创建它。但是可以用<code class="highlighter-rouge">+begin</code>和<code class="highlighter-rouge">+commit</code>分别来入栈或者出栈。</p>

<p>任何可以做动画的图层属性都会被添加到栈顶的事务，你可以通过<code class="highlighter-rouge">+setAnimationDuration:</code>方法设置当前事务的动画时间，或者通过<code class="highlighter-rouge">+animationDuration</code>方法来获取值（默认0.25秒）。</p>

<p>Core Animation在每个<em>run loop</em>周期中自动开始一次新的事务（run loop是iOS负责收集用户输入，处理定时器或者网络事件并且重新绘制屏幕的东西），即使你不显式的用<code class="highlighter-rouge">[CATransaction begin]</code>开始一次事务，任何在一次run loop循环中属性的改变都会被集中起来，然后做一次0.25秒的动画。</p>

<p>明白这些之后，我们就可以轻松修改变色动画的时间了。我们当然可以用当前事务的<code class="highlighter-rouge">+setAnimationDuration:</code>方法来修改动画时间，但在这里我们首先起一个新的事务，于是修改时间就不会有别的副作用。因为修改当前事务的时间可能会导致同一时刻别的动画（如屏幕旋转），所以最好还是在调整动画之前压入一个新的事务。</p>

<p>修改后的代码见清单7.2。运行程序，你会发现色块颜色比之前变得更慢了。</p>

<p>清单7.2 使用<code class="highlighter-rouge">CATransaction</code>控制动画时间</p>

<div class="highlighter-rouge"><pre class="highlight"><code>- (IBAction)changeColor
{
    //begin a new transaction
    [CATransaction begin];
    //set the animation duration to 1 second
    [CATransaction setAnimationDuration:1.0];
    //randomize the layer background color
    CGFloat red = arc4random() / (CGFloat)INT_MAX;
    CGFloat green = arc4random() / (CGFloat)INT_MAX;
    CGFloat blue = arc4random() / (CGFloat)INT_MAX;
    self.colorLayer.backgroundColor = [UIColor colorWithRed:red green:green blue:blue alpha:1.0].CGColor;
    ￼//commit the transaction
    [CATransaction commit];
}
</code></pre>
</div>

<p>如果你用过<code class="highlighter-rouge">UIView</code>的动画方法做过一些动画效果，那么应该对这个模式不陌生。<code class="highlighter-rouge">UIView</code>有两个方法，<code class="highlighter-rouge">+beginAnimations:context:</code>和<code class="highlighter-rouge">+commitAnimations</code>，和<code class="highlighter-rouge">CATransaction</code>的<code class="highlighter-rouge">+begin</code>和<code class="highlighter-rouge">+commit</code>方法类似。实际上在<code class="highlighter-rouge">+beginAnimations:context:</code>和<code class="highlighter-rouge">+commitAnimations</code>之间所有视图或者图层属性的改变而做的动画都是由于设置了<code class="highlighter-rouge">CATransaction</code>的原因。</p>

<p>在iOS4中，苹果对UIView添加了一种基于block的动画方法：<code class="highlighter-rouge">+animateWithDuration:animations:</code>。这样写对做一堆的属性动画在语法上会更加简单，但实质上它们都是在做同样的事情。</p>

<p><code class="highlighter-rouge">CATransaction</code>的<code class="highlighter-rouge">+begin</code>和<code class="highlighter-rouge">+commit</code>方法在<code class="highlighter-rouge">+animateWithDuration:animations:</code>内部自动调用，这样block中所有属性的改变都会被事务所包含。这样也可以避免开发者由于对<code class="highlighter-rouge">+begin</code>和<code class="highlighter-rouge">+commit</code>匹配的失误造成的风险。</p>

<h2 id="section-2">完成块</h2>

<p>基于<code class="highlighter-rouge">UIView</code>的block的动画允许你在动画结束的时候提供一个完成的动作。<code class="highlighter-rouge">CATranscation</code>接口提供的<code class="highlighter-rouge">+setCompletionBlock:</code>方法也有同样的功能。我们来调整上个例子，在颜色变化结束之后执行一些操作。我们来添加一个完成之后的block，用来在每次颜色变化结束之后切换到另一个旋转90的动画。代码见清单7.3，运行结果见图7.2。</p>

<p>清单7.3 在颜色动画完成之后添加一个回调</p>

<div class="highlighter-rouge"><pre class="highlight"><code>- (IBAction)changeColor
{
    //begin a new transaction
    [CATransaction begin];
    //set the animation duration to 1 second
    [CATransaction setAnimationDuration:1.0];
    //add the spin animation on completion
    [CATransaction setCompletionBlock:^{
        //rotate the layer 90 degrees
        CGAffineTransform transform = self.colorLayer.affineTransform;
        transform = CGAffineTransformRotate(transform, M_PI_2);
        self.colorLayer.affineTransform = transform;
    }];
    //randomize the layer background color
    CGFloat red = arc4random() / (CGFloat)INT_MAX;
    CGFloat green = arc4random() / (CGFloat)INT_MAX;
    CGFloat blue = arc4random() / (CGFloat)INT_MAX;
    self.colorLayer.backgroundColor = [UIColor colorWithRed:red green:green blue:blue alpha:1.0].CGColor;
    //commit the transaction
    [CATransaction commit];
}
</code></pre>
</div>

<p><img src="/img/in-post/ios_introduction/7.2.jpeg" alt="IMG" /></p>

<p>图7.2 颜色渐变之完成之后再做一次旋转</p>

<p>注意旋转动画要比颜色渐变快得多，这是因为完成块是在颜色渐变的事务提交并出栈之后才被执行，于是，用默认的事务做变换，默认的时间也就变成了0.25秒。</p>

<h2 id="section-3">图层行为</h2>

<p>现在来做个实验，试着直接对UIView关联的图层做动画而不是一个单独的图层。清单7.4是对清单7.2代码的一点修改，移除了<code class="highlighter-rouge">colorLayer</code>，并且直接设置<code class="highlighter-rouge">layerView</code>关联图层的背景色。</p>

<p>清单7.4 直接设置图层的属性</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">layerView</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
    <span class="c1">//set the color of our layerView backing layer directly
</span>    <span class="n">self</span><span class="p">.</span><span class="n">layerView</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">blueColor</span><span class="p">].</span><span class="n">CGColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">IBAction</span><span class="p">)</span><span class="n">changeColor</span>
<span class="p">{</span>
    <span class="c1">//begin a new transaction
</span>    <span class="p">[</span><span class="n">CATransaction</span> <span class="nf">begin</span><span class="p">];</span>
    <span class="c1">//set the animation duration to 1 second
</span>    <span class="p">[</span><span class="n">CATransaction</span> <span class="nf">setAnimationDuration</span><span class="p">:</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">];</span>
    <span class="c1">//randomize the layer background color
</span>    <span class="n">CGFloat</span> <span class="n">red</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
    <span class="n">CGFloat</span> <span class="n">green</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
    <span class="n">CGFloat</span> <span class="n">blue</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">layerView</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">colorWithRed</span><span class="p">:</span><span class="n">red</span> <span class="nf">green</span><span class="p">:</span><span class="n">green</span> <span class="n">blue</span><span class="o">:</span><span class="n">blue</span> <span class="n">alpha</span><span class="o">:</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">].</span><span class="n">CGColor</span><span class="p">;</span>
    <span class="c1">//commit the transaction
</span>    <span class="p">[</span><span class="n">CATransaction</span> <span class="nf">commit</span><span class="p">];</span>
<span class="p">}</span>
</code></pre>
</div>

<p>运行程序，你会发现当按下按钮，图层颜色瞬间切换到新的值，而不是之前平滑过渡的动画。发生了什么呢？隐式动画好像被<code class="highlighter-rouge">UIView</code>关联图层给禁用了。</p>

<p>试想一下，如果<code class="highlighter-rouge">UIView</code>的属性都有动画特性的话，那么无论在什么时候修改它，我们都应该能注意到的。所以，如果说UIKit建立在Core Animation（默认对所有东西都做动画）之上，那么隐式动画是如何被UIKit禁用掉呢？</p>

<p>我们知道Core Animation通常对<code class="highlighter-rouge">CALayer</code>的所有属性（可动画的属性）做动画，但是<code class="highlighter-rouge">UIView</code>把它关联的图层的这个特性关闭了。为了更好说明这一点，我们需要知道隐式动画是如何实现的。</p>

<p>我们把改变属性时<code class="highlighter-rouge">CALayer</code>自动应用的动画称作<em>行为</em>，当<code class="highlighter-rouge">CALayer</code>的属性被修改时候，它会调用<code class="highlighter-rouge">-actionForKey:</code>方法，传递属性的名称。剩下的操作都在<code class="highlighter-rouge">CALayer</code>的头文件中有详细的说明，实质上是如下几步：</p>

<ul>
  <li>图层首先检测它是否有委托，并且是否实现<code class="highlighter-rouge">CALayerDelegate</code>协议指定的<code class="highlighter-rouge">-actionForLayer:forKey</code>方法。如果有，直接调用并返回结果。</li>
  <li>如果没有委托，或者委托没有实现<code class="highlighter-rouge">-actionForLayer:forKey</code>方法，图层接着检查包含属性名称对应行为映射的<code class="highlighter-rouge">actions</code>字典。</li>
  <li>如果<code class="highlighter-rouge">actions字典</code>没有包含对应的属性，那么图层接着在它的<code class="highlighter-rouge">style</code>字典接着搜索属性名。</li>
  <li>最后，如果在<code class="highlighter-rouge">style</code>里面也找不到对应的行为，那么图层将会直接调用定义了每个属性的标准行为的<code class="highlighter-rouge">-defaultActionForKey:</code>方法。</li>
</ul>

<p>所以一轮完整的搜索结束之后，<code class="highlighter-rouge">-actionForKey:</code>要么返回空（这种情况下将不会有动画发生），要么是<code class="highlighter-rouge">CAAction</code>协议对应的对象，最后<code class="highlighter-rouge">CALayer</code>拿这个结果去对先前和当前的值做动画。</p>

<p>于是这就解释了UIKit是如何禁用隐式动画的：每个<code class="highlighter-rouge">UIView</code>对它关联的图层都扮演了一个委托，并且提供了<code class="highlighter-rouge">-actionForLayer:forKey</code>的实现方法。当不在一个动画块的实现中，<code class="highlighter-rouge">UIView</code>对所有图层行为返回<code class="highlighter-rouge">nil</code>，但是在动画block范围之内，它就返回了一个非空值。我们可以用一个demo做个简单的实验（清单7.5）</p>

<p>清单7.5 测试UIView的<code class="highlighter-rouge">actionForLayer:forKey:</code>实现</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">layerView</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
    <span class="c1">//test layer action when outside of animation block
</span>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Outside: %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">layerView</span> <span class="nf">actionForLayer</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">layerView</span><span class="p">.</span><span class="n">layer</span> <span class="nf">forKey</span><span class="p">:</span><span class="s">@"backgroundColor"</span><span class="p">]);</span>
    <span class="c1">//begin animation block
</span>    <span class="p">[</span><span class="n">UIView</span> <span class="nf">beginAnimations</span><span class="p">:</span><span class="nb">nil</span> <span class="nf">context</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="c1">//test layer action when inside of animation block
</span>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Inside: %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">layerView</span> <span class="nf">actionForLayer</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">layerView</span><span class="p">.</span><span class="n">layer</span> <span class="nf">forKey</span><span class="p">:</span><span class="s">@"backgroundColor"</span><span class="p">]);</span>
    <span class="c1">//end animation block
</span>    <span class="p">[</span><span class="n">UIView</span> <span class="nf">commitAnimations</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre>
</div>

<p>运行程序，控制台显示结果如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ LayerTest[21215:c07] Outside: &lt;null&gt;
$ LayerTest[21215:c07] Inside: &lt;CABasicAnimation: 0x757f090&gt;
</code></pre>
</div>

<p>于是我们可以预言，当属性在动画块之外发生改变，<code class="highlighter-rouge">UIView</code>直接通过返回<code class="highlighter-rouge">nil</code>来禁用隐式动画。但如果在动画块范围之内，根据动画具体类型返回相应的属性，在这个例子就是<code class="highlighter-rouge">CABasicAnimation</code>（第八章“显式动画”将会提到）。</p>

<p>当然返回<code class="highlighter-rouge">nil</code>并不是禁用隐式动画唯一的办法，<code class="highlighter-rouge">CATransaction</code>有个方法叫做<code class="highlighter-rouge">+setDisableActions:</code>，可以用来对所有属性打开或者关闭隐式动画。如果在清单7.2的<code class="highlighter-rouge">[CATransaction begin]</code>之后添加下面的代码，同样也会阻止动画的发生：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[CATransaction setDisableActions:YES];
</code></pre>
</div>

<p>总结一下，我们知道了如下几点</p>

<ul>
  <li><code class="highlighter-rouge">UIView</code>关联的图层禁用了隐式动画，对这种图层做动画的唯一办法就是使用<code class="highlighter-rouge">UIView</code>的动画函数（而不是依赖<code class="highlighter-rouge">CATransaction</code>），或者继承<code class="highlighter-rouge">UIView</code>，并覆盖<code class="highlighter-rouge">-actionForLayer:forKey:</code>方法，或者直接创建一个显式动画（具体细节见第八章）。</li>
  <li>对于单独存在的图层，我们可以通过实现图层的<code class="highlighter-rouge">-actionForLayer:forKey:</code>委托方法，或者提供一个<code class="highlighter-rouge">actions</code>字典来控制隐式动画。</li>
</ul>

<p>我们来对颜色渐变的例子使用一个不同的行为，通过给<code class="highlighter-rouge">colorLayer</code>设置一个自定义的<code class="highlighter-rouge">actions</code>字典。我们也可以使用委托来实现，但是<code class="highlighter-rouge">actions</code>字典可以写更少的代码。那么到底改如何创建一个合适的行为对象呢？</p>

<p>行为通常是一个被Core Animation<em>隐式</em>调用的<em>显式</em>动画对象。这里我们使用的是一个实现了<code class="highlighter-rouge">CATransition</code>的实例，叫做<em>推进过渡</em>。</p>

<p>第八章中将会详细解释过渡，不过对于现在，知道<code class="highlighter-rouge">CATransition</code>响应<code class="highlighter-rouge">CAAction</code>协议，并且可以当做一个图层行为就足够了。结果很赞，不论在什么时候改变背景颜色，新的色块都是从左侧滑入，而不是默认的渐变效果。</p>

<p>清单7.6 实现自定义行为</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">layerView</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="n">IBOutlet</span> <span class="n">CALayer</span> <span class="o">*</span><span class="n">colorLayer</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
    
    <span class="c1">//create sublayer
</span>    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span> <span class="o">=</span> <span class="p">[</span><span class="n">CALayer</span> <span class="nf">layer</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">50</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="mi">50</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">);</span>
    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">blueColor</span><span class="p">].</span><span class="n">CGColor</span><span class="p">;</span>
    <span class="c1">//add a custom action
</span>    <span class="n">CATransition</span> <span class="o">*</span><span class="n">transition</span> <span class="o">=</span> <span class="p">[</span><span class="n">CATransition</span> <span class="nf">animation</span><span class="p">];</span>
    <span class="n">transition</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">kCATransitionPush</span><span class="p">;</span>
    <span class="n">transition</span><span class="p">.</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">kCATransitionFromLeft</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">@{</span><span class="s">@"backgroundColor"</span><span class="o">:</span> <span class="n">transition</span><span class="p">};</span>
    <span class="c1">//add it to our view
</span>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">layerView</span><span class="p">.</span><span class="n">layer</span> <span class="nf">addSublayer</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">IBAction</span><span class="p">)</span><span class="n">changeColor</span>
<span class="p">{</span>
    <span class="c1">//randomize the layer background color
</span>    <span class="n">CGFloat</span> <span class="n">red</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
    <span class="n">CGFloat</span> <span class="n">green</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
    <span class="n">CGFloat</span> <span class="n">blue</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">colorWithRed</span><span class="p">:</span><span class="n">red</span> <span class="nf">green</span><span class="p">:</span><span class="n">green</span> <span class="n">blue</span><span class="o">:</span><span class="n">blue</span> <span class="n">alpha</span><span class="o">:</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">].</span><span class="n">CGColor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre>
</div>

<p><img src="/img/in-post/ios_introduction/7.3.jpeg" alt="IMG" /></p>

<p>图7.3 使用推进过渡的色值动画</p>

<h2 id="section-4">呈现与模型</h2>

<p><code class="highlighter-rouge">CALayer</code>的属性行为其实很不正常，因为改变一个图层的属性并没有立刻生效，而是通过一段时间渐变更新。这是怎么做到的呢？</p>

<p>当你改变一个图层的属性，属性值的确是立刻更新的（如果你读取它的数据，你会发现它的值在你设置它的那一刻就已经生效了），但是屏幕上并没有马上发生改变。这是因为你设置的属性并没有直接调整图层的外观，相反，他只是定义了图层动画结束之后将要变化的外观。</p>

<p>当设置<code class="highlighter-rouge">CALayer</code>的属性，实际上是在定义当前事务结束之后图层如何显示的<em>模型</em>。Core Animation扮演了一个<em>控制器</em>的角色，并且负责根据图层行为和事务设置去不断更新<em>视图</em>的这些属性在屏幕上的状态。</p>

<p>我们讨论的就是一个典型的<em>微型MVC模式</em>。<code class="highlighter-rouge">CALayer</code>是一个连接用户界面（就是MVC中的<em>view</em>）虚构的类，但是在界面本身这个场景下，<code class="highlighter-rouge">CALayer</code>的行为更像是存储了视图如何显示和动画的数据模型。实际上，在苹果自己的文档中，图层树通常都是值的图层树模型。</p>

<p>在iOS中，屏幕每秒钟重绘60次。如果动画时长比60分之一秒要长，Core Animation就需要在设置一次新值和新值生效之间，对屏幕上的图层进行重新组织。这意味着<code class="highlighter-rouge">CALayer</code>除了“真实”值（就是你设置的值）之外，必须要知道当前<em>显示</em>在屏幕上的属性值的记录。</p>

<p>每个图层属性的显示值都被存储在一个叫做<em>呈现图层</em>的独立图层当中，他可以通过<code class="highlighter-rouge">-presentationLayer</code>方法来访问。这个呈现图层实际上是模型图层的复制，但是它的属性值代表了在任何指定时刻当前外观效果。换句话说，你可以通过呈现图层的值来获取当前屏幕上真正显示出来的值（图7.4）。</p>

<p>我们在第一章中提到除了图层树，另外还有<em>呈现树</em>。呈现树通过图层树中所有图层的呈现图层所形成。注意呈现图层仅仅当图层首次被<em>提交</em>（就是首次第一次在屏幕上显示）的时候创建，所以在那之前调用<code class="highlighter-rouge">-presentationLayer</code>将会返回<code class="highlighter-rouge">nil</code>。</p>

<p>你可能注意到有一个叫做<code class="highlighter-rouge">–modelLayer</code>的方法。在呈现图层上调用<code class="highlighter-rouge">–modelLayer</code>将会返回它正在呈现所依赖的<code class="highlighter-rouge">CALayer</code>。通常在一个图层上调用<code class="highlighter-rouge">-modelLayer</code>会返回<code class="highlighter-rouge">–self</code>（实际上我们已经创建的原始图层就是一种数据模型）。</p>

<p><img src="/img/in-post/ios_introduction/7.4.jpeg" alt="IMG" /></p>

<p>图7.4 一个移动的图层是如何通过数据模型呈现的</p>

<p>大多数情况下，你不需要直接访问呈现图层，你可以通过和模型图层的交互，来让Core Animation更新显示。两种情况下呈现图层会变得很有用，一个是同步动画，一个是处理用户交互。</p>

<ul>
  <li>如果你在实现一个基于定时器的动画（见第11章“基于定时器的动画”），而不仅仅是基于事务的动画，这个时候准确地知道在某一时刻图层显示在什么位置就会对正确摆放图层很有用了。</li>
  <li>如果你想让你做动画的图层响应用户输入，你可以使用<code class="highlighter-rouge">-hitTest:</code>方法（见第三章“图层几何学”）来判断指定图层是否被触摸，这时候对<em>呈现</em>图层而不是<em>模型</em>图层调用<code class="highlighter-rouge">-hitTest:</code>会显得更有意义，因为呈现图层代表了用户当前看到的图层位置，而不是当前动画结束之后的位置。</li>
</ul>

<p>我们可以用一个简单的案例来证明后者（见清单7.7）。在这个例子中，点击屏幕上的任意位置将会让图层平移到那里。点击图层本身可以随机改变它的颜色。我们通过对呈现图层调用<code class="highlighter-rouge">-hitTest:</code>来判断是否被点击。</p>

<p>如果修改代码让<code class="highlighter-rouge">-hitTest:</code>直接作用于<em>colorLayer</em>而不是呈现图层，你会发现当图层移动的时候它并不能正确显示。这时候你就需要点击图层将要移动到的位置而不是图层本身来响应点击（这就是为什么用呈现图层来响应交互的原因）。</p>

<p>清单7.7 使用<code class="highlighter-rouge">presentationLayer</code>图层来判断当前图层位置</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">CALayer</span> <span class="o">*</span><span class="n">colorLayer</span><span class="p">;</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
    <span class="c1">//create a red layer
</span>    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span> <span class="o">=</span> <span class="p">[</span><span class="n">CALayer</span> <span class="nf">layer</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">CGPointMake</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">redColor</span><span class="p">].</span><span class="n">CGColor</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">layer</span> <span class="nf">addSublayer</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">touchesBegan</span><span class="o">:</span><span class="p">(</span><span class="n">NSSet</span> <span class="o">*</span><span class="p">)</span><span class="n">touches</span> <span class="n">withEvent</span><span class="o">:</span><span class="p">(</span><span class="n">UIEvent</span> <span class="o">*</span><span class="p">)</span><span class="n">event</span>
<span class="p">{</span>
    <span class="c1">//get the touch point
</span>    <span class="n">CGPoint</span> <span class="n">point</span> <span class="o">=</span> <span class="p">[[</span><span class="n">touches</span> <span class="nf">anyObject</span><span class="p">]</span> <span class="nf">locationInView</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">];</span>
    <span class="c1">//check if we've tapped the moving layer
</span>    <span class="k">if</span> <span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">presentationLayer</span> <span class="nf">hitTest</span><span class="p">:</span><span class="n">point</span><span class="p">])</span> <span class="p">{</span>
        <span class="c1">//randomize the layer background color
</span>        <span class="n">CGFloat</span> <span class="n">red</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
        <span class="n">CGFloat</span> <span class="n">green</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
        <span class="n">CGFloat</span> <span class="n">blue</span> <span class="o">=</span> <span class="n">arc4random</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">INT_MAX</span><span class="p">;</span>
        <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">colorWithRed</span><span class="p">:</span><span class="n">red</span> <span class="nf">green</span><span class="p">:</span><span class="n">green</span> <span class="n">blue</span><span class="o">:</span><span class="n">blue</span> <span class="n">alpha</span><span class="o">:</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">].</span><span class="n">CGColor</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//otherwise (slowly) move the layer to new position
</span>        <span class="p">[</span><span class="n">CATransaction</span> <span class="nf">begin</span><span class="p">];</span>
        <span class="p">[</span><span class="n">CATransaction</span> <span class="nf">setAnimationDuration</span><span class="p">:</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">self</span><span class="p">.</span><span class="n">colorLayer</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">point</span><span class="p">;</span>
        <span class="p">[</span><span class="n">CATransaction</span> <span class="nf">commit</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>@end</p>

<h2 id="section-5">总结</h2>

<p>这一章讨论了隐式动画，还有Core Animation对指定属性选择合适的动画行为的机制。同时你知道了UIKit是如何充分利用Core Animation的隐式动画机制来强化它的显式系统，以及动画是如何被默认禁用并且当需要的时候启用的。最后，你了解了呈现和模型图层，以及Core Animation是如何通过它们来判断出图层当前位置以及将要到达的位置。</p>

<p>在下一章中，我们将研究Core Animation提供的<em>显式</em>动画类型，既可以直接对图层属性做动画，也可以覆盖默认的图层行为。</p>


                <hr>

                


                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2016/06/27/ios_core_animation6_introduction/" data-toggle="tooltip" data-placement="top" title="IOS 动画讲解六">
                        Previous<br>
                        <span>IOS 动画讲解六</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2016/06/29/ios_core_animation8_introduction/" data-toggle="tooltip" data-placement="top" title="IOS 动画讲解八">
                        Next<br>
                        <span>IOS 动画讲解八</span>
                        </a>
                    </li>
                    
                </ul>


                

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
                				<a href="/tags/#Fedora" title="Fedora" rel="7">
                                    Fedora
                                </a>
                            
        				
                            
        				
                            
                				<a href="/tags/#Markdown" title="Markdown" rel="3">
                                    Markdown
                                </a>
                            
        				
                            
                				<a href="/tags/#Leetcode" title="Leetcode" rel="12">
                                    Leetcode
                                </a>
                            
        				
                            
                				<a href="/tags/#Algorithm" title="Algorithm" rel="13">
                                    Algorithm
                                </a>
                            
        				
                            
                				<a href="/tags/#PHP" title="PHP" rel="2">
                                    PHP
                                </a>
                            
        				
                            
                				<a href="/tags/#MacOS" title="MacOS" rel="5">
                                    MacOS
                                </a>
                            
        				
                            
                				<a href="/tags/#Jekyll" title="Jekyll" rel="3">
                                    Jekyll
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Android" title="Android" rel="13">
                                    Android
                                </a>
                            
        				
                            
                				<a href="/tags/#ios" title="ios" rel="21">
                                    ios
                                </a>
                            
        				
                            
                				<a href="/tags/#Xcode" title="Xcode" rel="3">
                                    Xcode
                                </a>
                            
        				
                            
                				<a href="/tags/#Mac" title="Mac" rel="2">
                                    Mac
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#core-animation" title="core-animation" rel="15">
                                    core-animation
                                </a>
                            
        				
                            
                				<a href="/tags/#tomcat" title="tomcat" rel="2">
                                    tomcat
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "davidwang";
    var disqus_identifier = "/2016/06/28/ios_core_animation7_introduction";
    var disqus_url = "http://DavidWangTM.github.io/2016/06/28/ios_core_animation7_introduction/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/DavidWangTM">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="http://weibo.com/David_wang_xm">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/DavidWangTM">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; DavidWang's Blog 2016
                    <br>
                    Theme © <a href="http://davidwangtm.github.io">davidwangtm</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=davidwangtm&repo=davidwangtm.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- Highlight.js -->
<script>
    async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
        hljs.initHighlightingOnLoad();
    })
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>
<link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">

<!--fastClick.js -->
<script>
    async("http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        // var $nav = document.querySelector("nav");
        // if($nav) FastClick.attach($nav);

        // global FastClick!!
        FastClick.attach(document.body);
    })
</script>

<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = '';
    var _gaDomain = 'DavidWangTM.github.io';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = '2436e853445e53365067f8975c3f123b';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
